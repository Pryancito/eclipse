# Various daemons that relibc needs to function as well as a bunch of env vars
# that should be set for every program.
export PATH /bin
export RUST_BACKTRACE full
rtcd
nulld
zerod
randd

# Logging
logd
stdio /scheme/log
ramfs logging

# Graphics infrastructure  
# inputd will be started by init_graphics.rc with proper parameters

# Load all graphics drivers (GPU hardware + vesad fallback)
# Priority: NVIDIA > AMD > Intel > BGA (QEMU) > VESA
run /scheme/initfs/etc/init_graphics.rc

# Boot framebuffer services
echo "[init] Iniciando servicios de framebuffer..."
fbbootlogd
fbcond 2

# Live disk
# Note: lived is disabled for harddisk installations to avoid I/O errors
# lived

# Load remaining PCI drivers (storage, network, etc.)
echo "[init] DEBUG: Ejecutando init_drivers.rc..."
run /scheme/initfs/etc/init_drivers.rc
echo "[init] DEBUG: init_drivers.rc completado"
unset RSDP_ADDR RSDP_SIZE

# Mount rootfs - mounts to /scheme/file
echo "[init] DEBUG: Intentando montar filesystem UUID=$REDOXFS_UUID BLOCK=$REDOXFS_BLOCK"
redoxfs --uuid $REDOXFS_UUID file $REDOXFS_BLOCK
unset REDOXFS_UUID REDOXFS_BLOCK REDOXFS_PASSWORD_ADDR REDOXFS_PASSWORD_SIZE

# Exit initfs - set file scheme as default so / points to /scheme/file
set-default-scheme file
cd /
export PATH /usr/bin

# Run init scripts (which will start ipcd, ptyd, etc.)
run.d /usr/lib/init.d /etc/init.d
